<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>유노RPG - 포켓로그 스타일 턴제 RPG 프로토타입</title>
<script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
<style>
  body { margin:0; padding:0; background: #111; color: #eee; font-family: 'Malgun Gothic', sans-serif; }
  #game-container { margin: 20px auto; display: block; width: 800px; height: 600px; border: 3px solid #444; background: #222; }
  .skill-button {
    font-size: 20px; padding: 8px 16px; margin: 5px;
    background: #333; color: #eee; border-radius: 5px; cursor: pointer;
    user-select: none; display: inline-block;
  }
  .skill-button:hover { background: #555; }
</style>
</head>
<body>
  <h1 style="text-align:center; margin-top:10px;">유노RPG</h1>
  <div id="game-container"></div>

<script>
  const config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    parent: 'game-container',
    physics: { default: 'arcade', arcade: { debug: false } },
    scene: { preload, create, update }
  };

  let player;
  let cursors;
  let enemy;
  let inBattle = false;
  let battleText;
  let turn = 'player'; // 'player' or 'enemy'
  let playerHP = 100;
  let enemyHP = 50;
  let skillButtons = [];

  const game = new Phaser.Game(config);

  function preload() {
    this.load.image('player', 'https://i.imgur.com/waPj8Ku.png'); // 플레이어 픽셀 이미지
    this.load.image('enemy', 'https://i.imgur.com/jf8k6Td.png');  // 적 픽셀 이미지
  }

  function create() {
    player = this.physics.add.sprite(100, 300, 'player');
    player.setCollideWorldBounds(true);

    enemy = this.physics.add.sprite(600, 300, 'enemy');

    cursors = this.input.keyboard.createCursorKeys();

    this.physics.add.overlap(player, enemy, () => {
      if (!inBattle) startBattle(this);
    });

    battleText = this.add.text(400, 50, '', { fontSize: '24px', fill: '#eee' }).setOrigin(0.5);
  }

  function update() {
    if (inBattle) return;

    player.setVelocity(0);
    if (cursors.left.isDown) player.setVelocityX(-150);
    else if (cursors.right.isDown) player.setVelocityX(150);
    if (cursors.up.isDown) player.setVelocityY(-150);
    else if (cursors.down.isDown) player.setVelocityY(150);
  }

  function startBattle(scene) {
    inBattle = true;
    battleText.setText('전투 시작! 당신의 턴입니다.');
    turn = 'player';

    createSkillButtons(scene);
  }

  function createSkillButtons(scene) {
    clearSkillButtons();

    const skill1 = scene.add.text(200, 500, '공격', { fontSize: '20px', fill: '#0f0', backgroundColor: '#222' })
      .setInteractive()
      .on('pointerdown', () => playerAttack(scene, 10))
      .setPadding(10)
      .setStyle({ backgroundColor: '#333' })
      .setOrigin(0.5);

    const skill2 = scene.add.text(400, 500, '강한 공격', { fontSize: '20px', fill: '#f00', backgroundColor: '#222' })
      .setInteractive()
      .on('pointerdown', () => playerAttack(scene, 20))
      .setPadding(10)
      .setStyle({ backgroundColor: '#333' })
      .setOrigin(0.5);

    skillButtons.push(skill1, skill2);
  }

  function clearSkillButtons() {
    skillButtons.forEach(btn => btn.destroy());
    skillButtons = [];
  }

  function playerAttack(scene, damage) {
    if (turn !== 'player') return;
    enemyHP -= damage;
    battleText.setText(`플레이어가 ${damage} 데미지를 입혔습니다! 적 HP: ${enemyHP}`);

    if (enemyHP <= 0) {
      battleText.setText('적을 쓰러뜨렸습니다! 전투 승리!');
      endBattle(scene);
    } else {
      turn = 'enemy';
      setTimeout(() => enemyAttack(scene), 1000);
    }
  }

  function enemyAttack(scene) {
    if (turn !== 'enemy') return;
    const damage = Phaser.Math.Between(5, 15);
    playerHP -= damage;
    battleText.setText(`적이 ${damage} 데미지를 입혔습니다! 플레이어 HP: ${playerHP}`);

    if (playerHP <= 0) {
      battleText.setText('플레이어가 쓰러졌습니다... 게임 오버!');
      endBattle(scene);
    } else {
      turn = 'player';
      battleText.setText('당신의 턴입니다.');
    }
  }

  function endBattle(scene) {
    inBattle = false;
    playerHP = 100;
    enemyHP = 50;
    clearSkillButtons();
    battleText.setText('');
  }
</script>

<!-- 자동 새로고침 스크립트 -->
<script>
  let lastContent = null;
  async function checkUpdate() {
    try {
      const res = await fetch(window.location.href, {cache: "no-store"});
      const text = await res.text();
      if (lastContent && lastContent !== text) {
        console.log("새 버전 발견! 새로고침합니다.");
        location.reload();
      }
      lastContent = text;
    } catch(e) {
      console.error("업데이트 확인 실패", e);
    }
  }
  setInterval(checkUpdate, 5000);
  checkUpdate();
</script>
</body>
</html>
